# إعداد نسخة SaaS من عجلة الحظ

## ما الذي تغيّر؟

- **تسجيل دخول وإنشاء حساب**: كل متجر يملك حساباً (Supabase Auth).
- **عزل البيانات**: إعدادات وجوائز ومشاركات كل مالك منفصلة.
- **رابط مشاركة**: لكل متجر رابط عام مثل `/w/متجرك` لمشاركته مع الزبائن.
- **لوحة تحكم محمية**: لوحة الإعدادات تظهر فقط للمالك بعد تسجيل الدخول (بدون كلمة مرور افتراضية).
- **باقات (Plans)**: مجاني (6 قطاعات)، أساسي (12 قطاع)، برو (غير محدود). الحد الحالي يُطبّق على عدد القطاعات في العجلة.

## خطوات الإعداد

### 1. تفعيل Auth في Supabase

1. من لوحة Supabase: **Authentication** → **Providers** → فعّل **Email**.
2. (اختياري) من **Authentication** → **URL Configuration** أضف عنوان الموقع بعد النشر في **Site URL** و **Redirect URLs** (مثل `https://yourdomain.com`).

### 2. تشغيل مخطط قاعدة البيانات (SaaS)

1. من Supabase: **SQL Editor** → New query.
2. انسخ محتوى الملف **`supabase-saas-schema.sql`** والصقه في المحرر.
3. نفّذ الاستعلام (Run).

هذا ينشئ:

- جدول `profiles` (ملف كل متجر مع `slug` فريد).
- جداول `settings`, `user_data`, `wins` مع عمود `owner_id`.
- دوال: `get_wheel_by_slug`, `insert_user_data_for_slug`, `insert_win_for_slug`, `update_segments_for_slug`.
- Trigger لإنشاء `profile` وصف إعدادات افتراضي تلقائياً عند تسجيل مستخدم جديد.
- RLS (Row Level Security) بحيث كل مستخدم يرى بياناته فقط.

إذا كان المشروع مُنشأً مسبقاً بدون عمود الباقات، نفّذ أيضاً **`supabase-plans-migration.sql`** في SQL Editor (إضافة عمود `plan` لجدول `profiles`).

### 3. متغيرات البيئة

تأكد من وجود نفس المتغيرات في `.env`:

```env
VITE_SUPABASE_URL=https://xxxxx.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
```

### 4. التشغيل والنشر

- محلياً: `npm run dev` ثم افتح `http://localhost:5173`.
- الصفحة الرئيسية `/`: تسجيل دخول أو إنشاء حساب.
- بعد الدخول: `/app` لعجلتك ولوحة التحكم.
- رابط المشاركة مع الزبائن: `https://yourdomain.com/w/{slug}` حيث `slug` يظهر في لوحة التحكم (مثل `متجري` أو `store-abc`).

## المسارات (Routes)

| المسار      | الوصف |
|------------|--------|
| `/`        | الصفحة الرئيسية (تسجيل دخول / إنشاء حساب / عجلتي إن كنت مسجلاً) |
| `/login`   | تسجيل الدخول |
| `/signup`  | إنشاء حساب (مع اسم المتجر اختياري) |
| `/app`     | لوحة التحكم + العجلة (يتطلب تسجيل دخول) |
| `/w/:slug` | عجلة عامة للمتجر (للمشاركة مع الزبائن) |

## الباقات

| الباقة  | القطاعات | الدورات/شهر | السعر (مثال) |
|--------|----------|-------------|---------------|
| مجاني  | 6        | 100         | مجاني         |
| أساسي  | 12       | 500         | 29 ر.س/شهر    |
| برو    | غير محدود | غير محدود   | 99 ر.س/شهر    |

تغيير باقة المستخدم يتم من Supabase: جدول **profiles** → عمود **plan** (`free` | `basic` | `pro`). ربط الدفع (Stripe / Moyasar) يمكن إضافته لاحقاً.

## ملاحظات

- **الـ slug** يُنشأ تلقائياً عند التسجيل من اسم المتجر أو البريد، ويمكن تغييره لاحقاً من جدول `profiles` في Supabase إن لزم.
- **البيانات القديمة** (جدول `settings` بدون `owner_id`) لا تُستخدم في النسخة SaaS؛ تحتاج إلى هجرة يدوية إن أردت نقلها لحساب معيّن.
