# إعداد روابط الدفع والاشتراك

## ماذا يحدث عند "اشترك الآن"؟

- إذا وُجد **رابط دفع** للباقة → يفتح صفحة الدفع (Stripe / Moyasar) في تاب جديد.
- إذا لم يوجد رابط دفع لكن وُجد **رقم واتساب** → يفتح واتساب مع رسالة جاهزة.
- إذا لم يُضبط أي منهما → تظهر رسالة للمستخدم.

---

## 1. إضافة الروابط في `.env`

في ملف `.env` في جذر المشروع:

```env
# روابط الدفع (اتركها فارغة لو تستخدم واتساب فقط)
VITE_PAYMENT_BASIC_URL=https://buy.stripe.com/xxxxx
VITE_PAYMENT_PRO_URL=https://buy.stripe.com/yyyyy

# واتساب للترقية (يُستخدم عند عدم وجود رابط دفع)
VITE_WHATSAPP_UPGRADE=201555936850
```

بعد التعديل: **أعد بناء المشروع** (`npm run build`) ثم انشر من جديد.

---

## 2. الحصول على رابط الدفع

### أ) Stripe (مناسب عالمياً وبطاقات دولية)

1. سجّل في [stripe.com](https://stripe.com) وأنشئ حساب.
2. من لوحة Stripe: **Product catalog** → **Add product**.
3. أنشئ منتجين:
   - **باقة أساسي**: اسم مثل "عجلة الحظ - أساسي"، سعر شهري (مثلاً 29 ر.س أو دولار).
   - **باقة برو**: اسم مثل "عجلة الحظ - برو"، سعر شهري (مثلاً 99 ر.س أو دولار).
4. لكل منتج: **Create payment link** (أو من **Payment links** → **New**).
5. انسخ الرابط (شكله `https://buy.stripe.com/...`) وضعه في `.env`:
   - رابط باقة أساسي → `VITE_PAYMENT_BASIC_URL`
   - رابط باقة برو → `VITE_PAYMENT_PRO_URL`

**ملاحظة:** Stripe يقبل عملات كثيرة. لو تريد ر.س سعودي قد تحتاج تفعيلها من إعدادات Stripe أو استخدام Moyasar.

---

### ب) Moyasar (مناسب السعودية والمنطقة — مدى، مدى، فيزا، أبل باي)

1. سجّل في [moyasar.com](https://moyasar.com).
2. من لوحة Moyasar أنشئ **مدفوعات/فواتير** أو استخدم **Payment Links** إن وُجد.
3. أو استخدم **Invoices**: أنشئ فاتورة بمبلغ باقة أساسي وأخرى باقة برو، وخذ رابط الدفع لكل فاتورة.
4. ضع الرابطين في `.env` كما في القسم 1.

(تفاصيل Moyasar قد تختلف قليلاً حسب واجهتهم الحالية — الرابط دائماً يكون من نطاق moyasar.com.)

---

### ج) أي مزود دفع يعطيك "رابط دفع"

إذا كان عندك مزود آخر (PayPal، Paymob، إلخ) ويعطيك **رابط ثابت** لصفحة دفع بمبلغ معيّن، ضع:
- رابط باقة أساسي في `VITE_PAYMENT_BASIC_URL`
- رابط باقة برو في `VITE_PAYMENT_PRO_URL`

---

## 3. تفعيل الباقة بعد الدفع

### يدوياً (الأبسط)

بعد ما يستلم العميل الدفع (بطاقة أو تحويل):

1. افتح **Supabase** → **Table Editor** → **profiles**.
2. ابحث عن المستخدم (بريده أو اسمه).
3. عدّل عمود **plan** إلى `basic` أو `pro` حسب الباقة اللي دفعها.

### تلقائياً (Webhook — اختياري)

مع Stripe أو Moyasar يمكن ربط **Webhook** بعد الدفع الناجح لتحديث `profiles.plan` تلقائياً. هذا يحتاج:
- سيرفر أو Supabase Edge Function يستقبل حدث الدفع.
- التحقق من توقيع الطلب (Stripe/Moyasar).
- تحديث `profiles.plan` حسب المنتج/المبلغ.

يمكن تنفيذ هذه الخطوة لاحقاً بعد استقرار روابط الدفع.

---

## ملخص سريع

| الخطوة | الإجراء |
|--------|---------|
| 1 | أنشئ منتجين/رابطي دفع (أساسي + برو) في Stripe أو Moyasar. |
| 2 | انسخ الرابطين وضعهم في `.env` في `VITE_PAYMENT_BASIC_URL` و `VITE_PAYMENT_PRO_URL`. |
| 3 | نفّذ `npm run build` ثم انشر الموقع. |
| 4 | بعد كل دفع ناجح حدّث الباقة يدوياً من Supabase أو لاحقاً عبر Webhook. |
